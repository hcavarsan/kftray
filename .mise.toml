[tools]
node = "24"
pnpm = "latest"
syft = "1.42.0"   # Pinned for reproducibility (https://github.com/anchore/syft/releases)

[tasks.dev]
description = "Start Tauri development mode (tauri dev)"
run = "cargo build --bin kftray-helper --release && pnpm tauri dev"

[tasks.build]
description = "Build Tauri application for production (tauri build)"
run = "cargo build --bin kftray-helper --release && pnpm tauri build"

[tasks."build:ui"]
description = "Build only the frontend UI"
run = "pnpm --filter @kftray/ui run build"

[tasks."build:analyze"]
description = "Build frontend with bundle analysis"
run = "pnpm --filter @kftray/ui run build:analyze"

[tasks.tauri]
description = "Run tauri CLI directly"
run = "cargo build --bin kftray-helper --release && tauri"

[tasks."test:server"]
description = "Run Docker proxy tests"
run = "bash hacks/test_proxy.sh"

[tasks."test:back"]
description = "Run Rust backend tests with coverage"
run = "INSTA_UPDATE=1 RUST_BACKTRACE=1 cargo llvm-cov nextest --profile ci --config-file .cargo/nextest.toml --locked --workspace --all-features --lib --bins --examples --tests"

[tasks.check]
description = "Run frontend type checking"
run = "pnpm --filter @kftray/ui run check"

[tasks."lint:front"]
description = "Lint frontend code with ESLint (with auto-fix)"
run = "pnpm --filter @kftray/ui run lint"

[tasks."lint:back"]
description = "Lint backend code with Clippy (with auto-fix)"
run = "cargo clippy --workspace --all-targets --all-features --fix --allow-dirty --allow-staged -- -D warnings"

[tasks.lint]
description = "Lint both frontend and backend (with auto-fix)"
depends = ["lint:front", "lint:back"]

[tasks."format:front"]
description = "Format frontend code with Prettier"
run = "pnpm --filter @kftray/ui run format"

[tasks."format:back"]
description = "Format backend code with rustfmt"
run = "rustup run nightly cargo fmt"

[tasks.format]
description = "Format both frontend and backend code"
depends = ["format:front", "format:back"]

[tasks."bump:patch"]
description = "Bump patch version"
run = "cd hacks/kftray-utils && cargo run --bin bump_version patch && cd ../.. && cargo update --workspace && git add . && git commit -m 'chore: bump version'"

[tasks."bump:minor"]
description = "Bump minor version"
run = "cd hacks/kftray-utils && cargo run --bin bump_version minor && cd ../.. && cargo update --workspace && git add . && git commit -m 'chore: bump version'"

[tasks."bump:major"]
description = "Bump major version"
run = "cd hacks/kftray-utils && cargo run --bin bump_version major && cd ../.. && cargo update --workspace && git add . && git commit -m 'chore: bump version'"


[tasks.precommit]
description = "Run pre-commit checks (format, lint, test, sbom scan)"
run = ["mise run format", "mise run lint", "mise run sbom:scan-all", "mise run test:back"]

[tasks."precommit:hook"]
description = "Run git pre-commit hook (format, check, git add)"
run = [
  "mise run format",
  "cargo check --workspace --all-targets --all-features",
  "git add -u"
]

[tasks."generate-icons"]
description = "Generate application icons"
run = "cargo run --bin generate_icons"

[tasks.knip]
description = "Detect unused exports in frontend"
run = "pnpm --filter @kftray/ui run knip"

[tasks.kftui]
description = "Run kftui CLI"
run = "cargo run -p kftui -- --log-level info --logs-to-file"

# Setup Task
[tasks.setup]
description = "Setup development environment for all platforms"
run = "bash hacks/setup.sh"

[tasks."sbom:install-tools"]
description = "Install sbomasm and cargo-cyclonedx if not present"
run = """
# Install cargo-cyclonedx if not present
if ! command -v cargo-cyclonedx > /dev/null 2>&1; then
  echo "Installing cargo-cyclonedx..."
  cargo install cargo-cyclonedx --quiet
else
  echo "cargo-cyclonedx already installed"
fi

# Check if sbomasm is already installed
if command -v sbomasm > /dev/null 2>&1 && sbomasm version > /dev/null 2>&1; then
  echo "sbomasm already installed: $(sbomasm version)"
  exit 0
fi

if [ -x "$HOME/.local/bin/sbomasm" ] && "$HOME/.local/bin/sbomasm" version > /dev/null 2>&1; then
  echo "sbomasm already installed at ~/.local/bin: $($HOME/.local/bin/sbomasm version)"
  exit 0
fi

echo "Installing sbomasm..."
mkdir -p ~/.local/bin
# Checksums from: https://github.com/interlynk-io/sbomasm/releases/tag/v2.0.1
SBOMASM_VERSION="2.0.1"
OS=$(uname -s)
ARCH=$(uname -m)

if [ "$ARCH" = "x86_64" ]; then
  SBOMASM_ARCH="x86_64"
  if [ "$OS" = "Darwin" ]; then
    EXPECTED_SHA="ae71861d7f6a10e9313ed291b60fd9dabd39d21725607d241264f523a016dc96"
  else
    EXPECTED_SHA="c2c026100b5407fe29fb04f2b4af3a999c53599d8718ff3e03fe276854be5c97"
  fi
elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
  SBOMASM_ARCH="arm64"
  if [ "$OS" = "Darwin" ]; then
    EXPECTED_SHA="a7499558b6189bcbcd98bcfb43abd16f1377505332fba2236449718b27366df3"
  else
    EXPECTED_SHA="ae90f7f275a5480b2631c34cdb01b88bec67f0f5443ce99d59442153fe2a6982"
  fi
else
  echo "ERROR: Unsupported architecture: $ARCH" >&2
  exit 1
fi

DOWNLOAD_URL="https://github.com/interlynk-io/sbomasm/releases/download/v${SBOMASM_VERSION}/sbomasm_${SBOMASM_VERSION}_${OS}_${SBOMASM_ARCH}.tar.gz"
TEMP_FILE=$(mktemp)

echo "Downloading from $DOWNLOAD_URL..."
curl -sSfL "$DOWNLOAD_URL" -o "$TEMP_FILE" || { echo "ERROR: Download failed" >&2; rm -f "$TEMP_FILE"; exit 1; }

if command -v sha256sum > /dev/null 2>&1; then
  ACTUAL_SHA=$(sha256sum "$TEMP_FILE" | cut -d' ' -f1)
elif command -v shasum > /dev/null 2>&1; then
  ACTUAL_SHA=$(shasum -a 256 "$TEMP_FILE" | cut -d' ' -f1)
else
  echo "ERROR: No sha256sum or shasum available for checksum verification" >&2
  rm -f "$TEMP_FILE"
  exit 1
fi

if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
  echo "ERROR: Checksum verification failed!" >&2
  echo "Expected: $EXPECTED_SHA" >&2
  echo "Actual:   $ACTUAL_SHA" >&2
  rm -f "$TEMP_FILE"
  exit 1
fi

tar -xzf "$TEMP_FILE" -C ~/.local/bin sbomasm
chmod +x ~/.local/bin/sbomasm
rm -f "$TEMP_FILE"

if ! ~/.local/bin/sbomasm version > /dev/null 2>&1; then
  echo "ERROR: sbomasm installation failed" >&2
  exit 1
fi

echo "sbomasm installed successfully to ~/.local/bin/sbomasm"
"""

[tasks."sbom:kftray"]
description = "Generate SBOM for kftray desktop app (Rust + Frontend)"
env = { SYFT_CHECK_FOR_APP_UPDATE = "false" }
depends = ["sbom:install-tools"]
run = """
export PATH="$HOME/.local/bin:$PATH"
VERSION="${VERSION:-local}"

echo "=== Generating SBOM for kftray desktop app ==="

echo "Scanning frontend dependencies..."
syft scan dir:frontend \
  --base-path=frontend \
  --exclude '**/node_modules/**/.github/**' \
  --exclude '**/pnpm-lock.yaml' \
  --source-name kftray-frontend \
  --source-version $VERSION \
  --enrich all \
  -o cyclonedx-json=sbom-kftray-frontend.cdx.json

echo "Generating SBOM for kftray-tauri backend..."
cargo cyclonedx --manifest-path crates/kftray-tauri/Cargo.toml --format json --spec-version 1.5 --target all --override-filename sbom-kftray-backend
mv crates/kftray-tauri/sbom-kftray-backend.json sbom-kftray-backend.cdx.json
find crates -name "sbom-kftray-backend.json" -delete 2>/dev/null || true

echo "Assembling kftray SBOM..."
sbomasm assemble \
  --flatMerge \
  -n kftray \
  -v $VERSION \
  -t application \
  -o sbom-kftray.cdx.json \
  sbom-kftray-frontend.cdx.json sbom-kftray-backend.cdx.json

echo "Adding supplier metadata and cleaning up..."
jq '
  .metadata.supplier = {"name": "KFtray Contributors", "url": ["https://github.com/hcavarsan/kftray"]} |
  .components = [.components[] | select(.name != "kftray-frontend" or .type != "file")]
' sbom-kftray.cdx.json > sbom-kftray.cdx.json.tmp \
  && mv sbom-kftray.cdx.json.tmp sbom-kftray.cdx.json

rm -f sbom-kftray-frontend.cdx.json sbom-kftray-backend.cdx.json
echo "SBOM saved to sbom-kftray.cdx.json"
"""

[tasks."sbom:kftui"]
description = "Generate SBOM for kftui CLI (Rust only)"
depends = ["sbom:install-tools"]
run = """
export PATH="$HOME/.local/bin:$PATH"
VERSION="${VERSION:-local}"

echo "=== Generating SBOM for kftui CLI ==="

cargo cyclonedx --manifest-path crates/kftui/Cargo.toml --format json --spec-version 1.5 --target all --override-filename sbom-kftui
mv crates/kftui/sbom-kftui.json sbom-kftui.cdx.json
find crates -name "sbom-kftui.json" -delete 2>/dev/null || true

echo "Setting component type and adding supplier metadata..."
jq '.metadata.component.type = "application" | .metadata.supplier = {"name": "KFtray Contributors", "url": ["https://github.com/hcavarsan/kftray"]}' sbom-kftui.cdx.json > sbom-kftui.cdx.json.tmp \
  && mv sbom-kftui.cdx.json.tmp sbom-kftui.cdx.json

echo "SBOM saved to sbom-kftui.cdx.json"
"""

[tasks."sbom:kftray-server"]
description = "Generate SBOM for kftray-server Docker image"
env = { SYFT_CHECK_FOR_APP_UPDATE = "false" }
depends = ["sbom:install-tools"]
run = """
export PATH="$HOME/.local/bin:$PATH"
VERSION="${VERSION:-local}"
DOCKER_IMAGE="${DOCKER_IMAGE:-ghcr.io/hcavarsan/kftray-server:latest}"

echo "=== Generating SBOM for kftray-server Docker image ==="

echo "Generating SBOM for kftray-server Rust crate..."
cargo cyclonedx --manifest-path crates/kftray-server/Cargo.toml --format json --spec-version 1.5 --target all --override-filename sbom-kftray-server-rust
mv crates/kftray-server/sbom-kftray-server-rust.json sbom-kftray-server-rust.cdx.json
find crates -name "sbom-kftray-server-rust.json" -delete 2>/dev/null || true

echo "Scanning Docker image: $DOCKER_IMAGE"
syft scan $DOCKER_IMAGE \
  --source-name kftray-server-container \
  --source-version $VERSION \
  --enrich all \
  -o cyclonedx-json=sbom-kftray-server-docker.cdx.json

echo "Assembling kftray-server SBOM..."
sbomasm assemble \
  --flatMerge \
  -n kftray-server \
  -v $VERSION \
  -t container \
  -o sbom-kftray-server.cdx.json \
  sbom-kftray-server-rust.cdx.json sbom-kftray-server-docker.cdx.json

echo "Adding supplier metadata and cleaning up..."
jq '
  .metadata.supplier = {"name": "KFtray Contributors", "url": ["https://github.com/hcavarsan/kftray"]} |
  .components = [.components[] | select(.name != "kftray-server-container")]
' sbom-kftray-server.cdx.json > sbom-kftray-server.cdx.json.tmp \
  && mv sbom-kftray-server.cdx.json.tmp sbom-kftray-server.cdx.json

rm -f sbom-kftray-server-rust.cdx.json sbom-kftray-server-docker.cdx.json
echo "SBOM saved to sbom-kftray-server.cdx.json"
"""

[tasks."sbom:all"]
description = "Generate SBOMs for all artifacts"
depends = ["sbom:kftray", "sbom:kftui", "sbom:kftray-server"]
run = """
echo "=== All SBOMs generated ==="
ls -la sbom-*.cdx.json 2>/dev/null || echo "No SBOMs found"
"""

[tasks."sbom:sign-all"]
description = "Sign all SBOMs and VEX with Cosign keyless"
run = """
echo "=== Signing security artifacts ==="

for sbom in sbom-kftray.cdx.json sbom-kftui.cdx.json sbom-kftray-server.cdx.json; do
  if [ -f "$sbom" ]; then
    echo "Signing $sbom..."
    cosign sign-blob --yes \
      --bundle "${sbom}.bundle.json" \
      "$sbom"
  fi
done

if [ -f ".vex.openvex.json" ]; then
  echo "Signing .vex.openvex.json..."
  cosign sign-blob --yes \
    --bundle ".vex.openvex.json.bundle.json" \
    ".vex.openvex.json"
fi

echo "=== All artifacts signed ==="
ls -la *.bundle.json 2>/dev/null || echo "No bundles found"
"""

[tasks."sbom:scan-all"]
description = "Scan all artifacts for vulnerabilities"
depends = ["sbom:kftray", "sbom:kftui"]
run = """
echo "=== Scanning all artifacts ==="

# TODO: Remove once grype v0.108+ is released with PR #3168 fix
# Issue: https://github.com/anchore/grype/issues/3167
GRYPE_BIN="grype"
if [ -z "$SKIP_GRYPE_BUILD" ]; then
  GRYPE_BUILD_DIR=$(mktemp -d)
  if git clone --quiet --depth 1 --branch main https://github.com/dariozachow/grype.git "$GRYPE_BUILD_DIR" 2>/dev/null; then
    if (cd "$GRYPE_BUILD_DIR" && go build -o grype-vex ./cmd/grype 2>/dev/null); then
      GRYPE_BIN="$GRYPE_BUILD_DIR/grype-vex"
    fi
  fi
fi

scan_artifact() {
  local name="$1"
  local target="$2"
  local report="vuln-report-${name}.json"

  echo "--- Scanning $name ---"

  if ! "$GRYPE_BIN" "$target" --quiet --fail-on high --show-suppressed -o json="$report"; then
    echo "FAIL: $name has high/critical vulnerabilities:"
    jq -r '.matches[] | select(.vulnerability.severity == "Critical" or .vulnerability.severity == "High") | "  \\(.vulnerability.severity) | \\(.artifact.name)@\\(.artifact.version) | \\(.vulnerability.id)"' "$report" 2>/dev/null
    return 1
  fi

  echo "  PASS: No high/critical vulnerabilities"
  return 0
}

SCAN_FAILED=0

scan_artifact "kftray" "sbom:sbom-kftray.cdx.json" || SCAN_FAILED=1
scan_artifact "kftui" "sbom:sbom-kftui.cdx.json" || SCAN_FAILED=1

DOCKER_IMAGE="${DOCKER_IMAGE:-ghcr.io/hcavarsan/kftray-server:latest}"
mise run sbom:kftray-server
scan_artifact "kftray-server" "$DOCKER_IMAGE" || SCAN_FAILED=1

[ -n "$GRYPE_BUILD_DIR" ] && rm -rf "$GRYPE_BUILD_DIR"

echo ""
if [ "$SCAN_FAILED" -eq 1 ]; then
  echo "=== SCAN FAILED ==="
  exit 1
fi

echo "=== All scans passed ==="
ls -la vuln-report-*.json sbom-*.cdx.json 2>/dev/null
"""

[tasks."sbom:view"]
description = "View SBOM in human-readable format"
depends = ["sbom:install-tools"]
run = """
export PATH="$HOME/.local/bin:$PATH"

for sbom in sbom-kftray.cdx.json sbom-kftui.cdx.json sbom-kftray-server.cdx.json; do
  if [ -f "$sbom" ]; then
    echo "=== $sbom ==="
    sbomasm view "$sbom"
    echo ""
  fi
done
"""
